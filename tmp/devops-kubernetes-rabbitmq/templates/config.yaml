---
apiVersion: v1
kind: Secret
metadata:
  name: cookie
  namespace: {{.namespace}}
  labels:
    app: rabbitmq
    component: rabbitmq
    role: services
type: Opaque
data:
  rabbitmq.cookie: {{.cookie}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
  namespace: {{.namespace}}
  labels:
    app: rabbitmq
    component: rabbitmq
    role: services
data:
  init.sh: |
    #!/usr/bin/env sh
    KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    curl --request POST --data '{"jwt": "'"$KUBE_TOKEN"'", "role": "rabbitmq_{{.env}}"}' ${VAULT_ADDR}/v1/auth/kubernetes/login | jq -j '.auth.client_token' > /tmp/vault_token
    X_VAULT_TOKEN=$(cat /tmp/vault_token)
    curl --header "X-Vault-Token: $X_VAULT_TOKEN" ${VAULT_ADDR}/v1/secret/data/{{.env}}/rabbitmq > /tmp/creds.json
    USER_NB=$(cat /tmp/creds.json | jq -j '.data.data | keys | length')
    while [ ${USER_NB} -ge 0 ]; do
        set -x
        USER_NB=$((USER_NB - 1))
        USER=$(cat /tmp/creds.json | jq -j '.data.data | keys['${USER_NB}']')
        PASSWORD=$(cat /tmp/creds.json | jq -j '.data.data.'${USER}'')
        echo '{"name": "'${USER}'","password_hash": "'${PASSWORD}'","hashing_algorithm": "rabbit_password_hashing_sha256","tags": "administrator"}' >> /tmp/tmp_user.json
    done
    cp -rf /tmp/tmpl_definitions.json /tmp/rabbitmq-definitions/definitions.json
    cat /tmp/tmp_user.json | sort | uniq > /tmp/user.json
    sed -i '$!s/$/,/' /tmp/user.json
    sed -i '/users/ r /tmp/user.json' /tmp/rabbitmq-definitions/definitions.json
  enabled_plugins: |
    [rabbitmq_management,rabbitmq_peer_discovery_k8s,rabbitmq_consistent_hash_exchange,rabbitmq_delayed_message_exchange,rabbitmq_top,rabbitmq_federation,rabbitmq_federation_management,rabbitmq_mqtt,rabbitmq_shovel,rabbitmq_shovel_management,rabbitmq_stomp,rabbitmq_web_stomp,rabbitmq_delayed_message_exchange].
  rabbitmq.conf: |
    ## Clustering
    cluster_formation.peer_discovery_backend  = rabbit_peer_discovery_k8s
    cluster_formation.k8s.host = kubernetes.default.svc.cluster.local
    cluster_formation.k8s.address_type = ip
    cluster_formation.node_cleanup.interval = 10
    cluster_formation.node_cleanup.only_log_warning = false
    cluster_partition_handling = autoheal
    ## queue master locator
    queue_master_locator=min-masters
    ## enable guest user
    loopback_users.guest = false
    heartbeat = {{.heartbeat}}

    listeners.tcp.default = 5672
    # default_user = beamery
    # default_pass = Ub3rm3nch
    hipe_compile = false
    management.listener.port = 15672
    management.listener.ssl = false

    management.load_definitions = /tmp/rabbitmq-definitions/definitions.json
  rabbitmq.definitions: |
    {
      "rabbit_version":"3.7.2",
      "users":[
      ],
      "vhosts":[
        {
          "name":"/"
        },
        {
          "name":"{{.vhost_name}}"
        }
      ],
      "permissions":[
        {
          "user":"beamery",
          "vhost":"{{.vhost_name}}",
          "configure":".*",
          "write":".*",
          "read":".*"
        },
        {
          "user":"beamery",
          "vhost":"/",
          "configure":".*",
          "write":".*",
          "read":".*"
        },
        {
          "user":"guest",
          "vhost":"/",
          "configure":".*",
          "write":".*",
          "read":".*"
        }
      ],
      "topic_permissions":[],
      "parameters":[],
      "global_parameters":[
        {
          "name":"cluster_name",
          "value":"rabbit@rabbitmq-0.rabbitmq.rabbitmq.svc.cluster.local"
        }
      ],
      "policies":[
        {
          "vhost":"{{.vhost_name}}",
          "name":"Vacancies HA/DLX",
          "pattern":"^vacancies$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"vacancies:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"Events HA/DLX",
          "pattern":"^events$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"events:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"ha-all",
          "pattern":".*",
          "apply-to":"queues",
          "definition":
            {
              "ha-mode":"all"
            },
          "priority":0
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"Contacts Bulk Imports HA/DLX",
          "pattern":"^contactsBulkImports$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"contactsBulkImports:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"GH Delay",
          "pattern":"integrations\\.greenhouse:delayed",
          "apply-to":"queues",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"integrations.greenhouse",
              "message-ttl":60000
            },
          "priority":2
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"Sherlock HA/DLX",
          "pattern":"^sherlock$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"sherlock:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
         {
          "vhost":"{{.vhost_name}}",
          "name":"leaderboards",
          "pattern":"^leaderboards",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"leaderboards:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"HA",
          "pattern":"^(?!amq\\.).*",
          "apply-to":"queues",
          "definition":
            {
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":-10
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"Vacancies DLX",
          "pattern":"^vacancies",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"Digests HA/DLX",
          "pattern":"^digests$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"digests:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"\"All\" HA / DLX",
          "pattern":"^all$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"all:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"Workday HA/DLX",
          "pattern":"^integrations\\.workday$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"integrations.workday:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"/",
          "name":"ha-all",
          "pattern":".*",
          "apply-to":"queues",
          "definition":
            {
              "ha-mode":"all"
            },
          "priority":0
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"Bulk Actions HA/DLX",
          "pattern":"^bulkActions$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.failed",
              "dead-letter-routing-key":"bulkActions:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"GH HA/DLX",
          "pattern":"integrations\\.greenhouse",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"integrations.greenhouse:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"Jobvite HA/DLX",
          "pattern":"integrations\\.jobvite",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"integrations.jobvite:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"Generic HA/DLX",
          "pattern":"integrations\\.generic",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"integrations.generic:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.vhost_name}}",
          "name":"Jobvite Nifi HA/DLX",
          "pattern":"integrations\\.jobvite\\.sync:nifi",
          "apply-to":"all",
          "definition":
            {
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        }
      ],
      "queues":[
        {
          "name":"all:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"contactsBulkImports",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"contactsBulkImports:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
                {
          "name":"leaderboards",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"leaderboards:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"vacancies",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"all",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"bulkActions",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"campaigns:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"bulkActions:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"sherlock",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.jazz:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.greenhouse:delayed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"all-attachments-shovel",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.workday:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"contactsBulkImports:failed-tmp",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.workday",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"events",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"vacancies:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.greenhouse:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"digests:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"sherlock:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"campaigns",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.workday-tmp",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.jazz",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.greenhouse",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.generic",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.jobvite",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.jobvite.sync:nifi",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.jobvite:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.generic:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"digests",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"events:failed",
          "vhost":"{{.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        }
      ],
      "exchanges":[
        {
          "name":"amqp.delayed.campaigns",
          "vhost":"{{.vhost_name}}",
          "type":"x-delayed-message",
          "durable":true,
          "auto_delete":false,
          "internal":false,
          "arguments": { "x-delayed-type":"direct" }
        },
        {
          "name":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "type":"direct",
          "durable":true,
          "auto_delete":false,
          "internal":false,
          "arguments":{}
        },
        {
          "name":"campaigns",
          "vhost":"{{.vhost_name}}",
          "type":"fanout",
          "durable":true,
          "auto_delete":false,
          "internal":false,
          "arguments":{}
        },
        {
          "name":"web",
          "vhost":"{{.vhost_name}}",
          "type":"direct",
          "durable":true,
          "auto_delete":false,
          "internal":false,
          "arguments":{}
        },
        {
          "name":"amqp.delayed",
          "vhost":"{{.vhost_name}}",
          "type":"x-delayed-message",
          "durable":true,
          "auto_delete":false,
          "internal":false,
          "arguments": { "x-delayed-type":"direct" }
        }
      ],
      "bindings":[
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"all:failed",
          "destination_type":"queue",
          "routing_key":"all:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"bulkActions:failed",
          "destination_type":"queue",
          "routing_key":"bulkActions:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"campaigns:failed",
          "destination_type":"queue",
          "routing_key":"campaigns:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"contactsBulkImports:failed",
          "destination_type":"queue",
          "routing_key":"contactsBulkImports:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"digests:failed",
          "destination_type":"queue",
          "routing_key":"digests:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"events:failed",
          "destination_type":"queue",
          "routing_key":"events:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"integrations.greenhouse",
          "destination_type":"queue",
          "routing_key":"integrations.greenhouse",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"integrations.greenhouse:failed",
          "destination_type":"queue",
          "routing_key":"integrations.greenhouse:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"integrations.workday:failed",
          "destination_type":"queue",
          "routing_key":"integrations.workday:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"sherlock:failed",
          "destination_type":"queue",
          "routing_key":"sherlock:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.vhost_name}}",
          "destination":"vacancies:failed",
          "destination_type":"queue",
          "routing_key":"vacancies:failed",
          "arguments":{}
        },
        {
          "source":"amqp.delayed",
          "vhost":"{{.vhost_name}}",
          "destination":"all",
          "destination_type":"queue",
          "routing_key":"all",
          "arguments":{}
        },
        {
          "source":"amqp.delayed",
          "vhost":"{{.vhost_name}}",
          "destination":"campaigns",
          "destination_type":"queue",
          "routing_key":"campaigns",
          "arguments":{}
        },
        {
          "source":"amqp.delayed",
          "vhost":"{{.vhost_name}}",
          "destination":"events",
          "destination_type":"queue",
          "routing_key":"events",
          "arguments":{}
        },
        {
          "source":"amqp.delayed",
          "vhost":"{{.vhost_name}}",
          "destination":"vacancies",
          "destination_type":"queue",
          "routing_key":"vacancies",
          "arguments":{}
        },
        {
          "source":"amqp.delayed.campaigns",
          "vhost":"{{.vhost_name}}",
          "destination":"campaigns",
          "destination_type":"queue",
          "routing_key":"campaigns",
          "arguments":{}
        }
      ]
    }
